# 3.4 Format String

## 3.3.0 실제 사례

## 3.3.1 정의와 원리

### 정의

Format String은 사용하는 함수에 대해 어떤 형식 또는 형태를 지정해주는 문자열을 의미합니다. 예를 들어, char str = "World!"; printf("Hello, %s\n", str);와 같은 코드에서 %s가 Format String에 해당하며, str 변수의 값이 Format String에 따라 출력 됩니다.

Format String 공격은 이러한 Format String의 특성을 이용하여 해커가 원하는 코드를 실행시키는 공격 기법입니다. 공격자는 **%n**(이전까지 출력한 총 바이트 수를 지정한 변수-4 바이트 단위-에 저장)과 같은 특수한 Format String을 이용하여 프로그램의 메모리를 조작하거나, %x(양의 정수-16 진수-)와 같은 Format String을 이용하여 시스템의 중요한 정보를 유출 시킬 수 있습니다.

### 원리

Format String 공격은 데이터의 형태와 길이에 대한 불명확한 정의로 인해 발생합니다. Format String을 인자로 하는 함수 사용 시 Format String을 지정하지 않고 사용자 입력을 통해서 Format String이 결정되면 해커는 이를 조작하여 메모리 내용을 참조하고 특정 영역의 값을 변경합니다. 예를 들어, printf(user_input);와 같이 코드가 작성된 경우 사용자 입력에 포맷 지시어 (예: %x %x %x)를 포함시켜 이를 통해 메모리 내용 참조 및 원하는 위치로 이동한 뒤 특수한 포맷 지시어 (예: %n)을 통해 복귀 주소를 변경하여 악성 코드를 실행할 수 있습니다.

## 3.3.2 공격 유형

Format String은 다양한 방식으로 공격에 사용될 수 있습니다. 

- **Format String Buffer Overflow 공격**

Format String을 사용하여 Buffer Overflow 공격을 수행할 수 있습니다. Format String의 %n 포맷 지시어를 사용하여 버퍼의 크기를 초과하는 데이터를 입력하면, Buffer Overflow가 발생하여 해커가 원하는 데이터를 변경하거나 새로운 코드를 삽입할 수 있습니다. 또한 Format String의 %n 포맷 지시어를 사용하여 버퍼의 크기를 초과하는 데이터를 입력하면, 시스템의 메모리 부족으로 인해 서비스가 거부될 수 있습니다.

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/579fe283-28aa-489d-ae65-d683304becfc/6d80a63f-9775-4817-97b2-89b5d28a089c/Untitled.png)

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/579fe283-28aa-489d-ae65-d683304becfc/70120b14-dd09-41c6-ad01-3e334f34e7cd/Untitled.png)

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/579fe283-28aa-489d-ae65-d683304becfc/5227f589-75ff-48a7-8c74-475b39c45dac/Untitled.png)

- **취약점 스캐닝 공격**

Format String을 사용하여 취약점 스캐닝 공격을 수행할 수 있습니다. 포맷 지시어 %p를 사용하여 메모리 주소를 출력하면, 공격자는 시스템의 취약점을 식별할 수 있습니다.

- **정보 유출 공격**

Format String을 사용하여 정보 유출 공격을 수행할 수 있습니다. 포맷 지시어 %s를 사용하여 시스템의 민감한 정보를 출력하면, 공격자는 시스템의 정보를 탈취할 수 있습니다.

## 3.3.3 대응 방법

1. **입력 검증**:
    - **유효한 입력만 허용**: 애플리케이션에서 받은 입력을 검증하여 유효한 입력만 받아들입니다.
2. **안전한 프로그래밍**:
    - **포맷 문자열 사용을 피함**: 포맷 문자열을 사용하는 함수 대신 안전한 함수를 사용합니다.
    - **포맷 문자열 인자 사용**: 문자열을 만들 때 포맷 문자열 인자를 제대로 사용하여 공격을 피합니다.
    - **적절한 출력 함수 사용:** 포맷 지정자가 필요 없는 경우, puts나 fputs와 같은 함수를 사용하여 출력을 합니다.
    - **경고 메시지 주의:** 대부분의 컴파일러는 포맷 문자열 취약점과 관련된 잠재적 위험을 감지하여 경고 메시지를 제공합니다. 이러한 경고 메시지에 주의를 기울이고, 코드를 적절하게 수정하여 문제를 해결합니다.
3. **코드 리뷰와 테스팅**:
    - **코드 리뷰**: 코드 리뷰를 통해 보안 취약점을 식별하고 수정합니다.
    - **자동화된 테스팅 도구**: 자동화된 테스팅 도구를 사용하여 코드 베이스를 검사하고 취약점을 찾아냅니다.
4. **보안 교육**:
    - **개발자 교육**: 개발자들에게 보안에 관한 교육을 제공하여 취약점을 줄입니다.
5. **보안 정책과 프로시저**:
    - **보안 기준 준수**: 산업 표준 및 보안 베스트 프랙티스를 준수하여 프로그램을 개발합니다.